

# Plan: Create `proofs` Table in Supabase

## Purpose

Store proof reports generated by users. Currently NewProof.tsx uses mock data and Dashboard.tsx shows an empty "Recent Proofs" section. This table will persist proof results so they can be listed, viewed, and deleted.

## Pre-Flight Checklist

| Check | Status |
|-------|--------|
| No breaking changes to existing queries | OK -- no code currently queries a `proofs` table |
| RLS enabled, deny-by-default | Yes -- will enable RLS and add restrictive policies |
| UUID primary key + created_at default now() | Yes |
| No circular foreign keys | OK -- single FK to `profiles.id` |
| Indexes on frequently queried columns | Yes -- index on `user_id` and `created_at` |

## Table Schema

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| `id` | uuid | No | `gen_random_uuid()` | Primary key |
| `user_id` | uuid | No | `auth.uid()` | FK to `profiles.id`, indexed |
| `domain` | text | No | -- | Target domain (e.g. `example.com`) |
| `keyword` | text | No | -- | Target keyword |
| `score` | integer | No | -- | Proof score 0-100 |
| `current_rank` | integer | Yes | -- | Current SERP position |
| `delta_30` | integer | Yes | -- | 30-day rank change |
| `ai_overview` | boolean | Yes | false | Has AI overview in SERP |
| `rankings` | jsonb | Yes | `'[]'` | Array of `{keyword, position}` objects |
| `narrative` | text | Yes | -- | AI-generated sales narrative |
| `created_at` | timestamptz | No | `now()` | Creation timestamp, indexed |

## RLS Policies (Restrictive, deny-by-default)

1. **proofs_select_own** -- Users can only SELECT their own proofs
2. **proofs_insert_own** -- Users can only INSERT proofs where `user_id = auth.uid()`
3. **proofs_delete_own** -- Users can only DELETE their own proofs

No UPDATE policy -- proofs are immutable once generated.

## Complete SQL Migration

```sql
-- Create proofs table
create table public.proofs (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null default auth.uid() references public.profiles(id) on delete cascade,
  domain text not null,
  keyword text not null,
  score integer not null,
  current_rank integer,
  delta_30 integer,
  ai_overview boolean default false,
  rankings jsonb default '[]'::jsonb,
  narrative text,
  created_at timestamptz not null default now()
);

-- Enable RLS
alter table public.proofs enable row level security;

-- RLS policies (restrictive)
create policy "proofs_select_own"
  on public.proofs for select
  using (auth.uid() = user_id);

create policy "proofs_insert_own"
  on public.proofs for insert
  with check (auth.uid() = user_id);

create policy "proofs_delete_own"
  on public.proofs for delete
  using (auth.uid() = user_id);

-- Indexes for Dashboard queries (ORDER BY created_at, WHERE user_id)
create index idx_proofs_user_id on public.proofs(user_id);
create index idx_proofs_created_at on public.proofs(created_at desc);
```

## Impact on Existing Code

- **No breaking changes.** No existing code queries `proofs` yet.
- After this migration, Dashboard.tsx and NewProof.tsx can be updated to read/write from this table.
- The `profiles.proofs_used` counter should be incremented via a trigger or in application code when a proof is inserted (separate task).

## What This Does NOT Include

- No code changes (this is schema only)
- No trigger to auto-increment `profiles.proofs_used` (can be added separately)
- No edge function changes

Reply **"Run this SQL"** to execute the migration.

